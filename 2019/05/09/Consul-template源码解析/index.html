<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="哈利土土"><meta name="copyright" content="哈利土土"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>Consul template源码解析 | null</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/images/avatar.png"><link rel="mask-icon" href="/images/avatar.png" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"photon.fun","root":"/","title":"独钓寒江雪","version":"1.8.6","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-G6100ZS3DQ"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-G6100ZS3DQ');
}</script><meta name="description" content="上一篇文章简单介绍了一下Consul-template基本用法，本篇主要深入看一下consul-template的源码。 Consul-template的整个流程还是比较清晰的，不过代码中大量运用了goroutine、channel和goto等高级特性，如果不仔细看的话，有些地方可能理不清楚。 下图即是consul-template的整个执行流程。整个流程开有多个单独的goroutine，分别是监">
<meta property="og:type" content="article">
<meta property="og:title" content="Consul template源码解析">
<meta property="og:url" content="https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name">
<meta property="og:description" content="上一篇文章简单介绍了一下Consul-template基本用法，本篇主要深入看一下consul-template的源码。 Consul-template的整个流程还是比较清晰的，不过代码中大量运用了goroutine、channel和goto等高级特性，如果不仔细看的话，有些地方可能理不清楚。 下图即是consul-template的整个执行流程。整个流程开有多个单独的goroutine，分别是监">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiaodongliu.com/images/2019051201.png">
<meta property="article:published_time" content="2019-05-09T03:46:22.000Z">
<meta property="article:modified_time" content="2022-02-01T09:17:59.894Z">
<meta property="article:author" content="哈利土土">
<meta property="article:tag" content="Consul">
<meta property="article:tag" content="Consul-template">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xiaodongliu.com/images/2019051201.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="哈利土土"><img width="96" loading="lazy" src="/images/avatar.png" alt="哈利土土"></a><div class="site-author-name"><a href="/about/">哈利土土</a></div><span class="site-name"></span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">40</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">19</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/tarepanda1024" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:liuxd2017@163.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/liu-xiao-dong-40-19/activities" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/index.html" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B5%84%E6%BA%90"><span class="toc-number">1.</span> <span class="toc-text">初始化资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8de-dup%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8C%E6%95%B0%E6%8D%AE%E7%9B%91%E6%8E%A7goroutine"><span class="toc-number">2.</span> <span class="toc-text">启动de-dup管理器和数据监控goroutine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.</span> <span class="toc-text">渲染模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7consul-kv"><span class="toc-number">4.</span> <span class="toc-text">监控consul-kv</span></a></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/Consul/" style="font-size: 16.5px; color: #7391ad">Consul</a> <a href="/tags/Consul-template/" style="font-size: 16.5px; color: #7391ad">Consul-template</a> <a href="/tags/Golang/" style="font-size: 16.5px; color: #7391ad">Golang</a> <a href="/tags/Istio/" style="font-size: 12px; color: #999">Istio</a> <a href="/tags/Java/" style="font-size: 30px; color: #0078e7">Java</a> <a href="/tags/Kong/" style="font-size: 25.5px; color: #2680d4">Kong</a> <a href="/tags/Lombok/" style="font-size: 12px; color: #999">Lombok</a> <a href="/tags/Lua/" style="font-size: 21px; color: #4d89c0">Lua</a> <a href="/tags/Maven/" style="font-size: 12px; color: #999">Maven</a> <a href="/tags/Mysql/" style="font-size: 12px; color: #999">Mysql</a> <a href="/tags/Nginx/" style="font-size: 12px; color: #999">Nginx</a> <a href="/tags/Redis/" style="font-size: 16.5px; color: #7391ad">Redis</a> <a href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" style="font-size: 12px; color: #999">字节码</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 12px; color: #999">工具</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 12px; color: #999">总结</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 12px; color: #999">数据库</a> <a href="/tags/%E7%BD%91%E5%85%B3/" style="font-size: 25.5px; color: #2680d4">网关</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 12px; color: #999">读书笔记</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 21px; color: #4d89c0">随笔</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="哈利土土"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Consul template源码解析</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2019-05-09 11:46:22" itemprop="dateCreated datePublished" datetime="2019-05-09T11:46:22+08:00">2019-05-09</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">微服务</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Consul/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Consul</span></a><a class="tag-item" href="/tags/Consul-template/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Consul-template</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>上一篇文章简单介绍了一下<a href="/2019/05/11/Consul-template%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/">Consul-template基本用法</a>，本篇主要深入看一下consul-template的源码。</p>
<p>Consul-template的整个流程还是比较清晰的，不过代码中大量运用了goroutine、channel和goto等高级特性，如果不仔细看的话，有些地方可能理不清楚。</p>
<p>下图即是consul-template的整个执行流程。整个流程开有多个单独的goroutine，分别是监听信号重新加载配置或者停止、监听consul kv存储的变化发送更新通知、监听数据的更新通知以及渲染模板并执行命令等<br><img src="https://xiaodongliu.com/images/2019051201.png" alt="Consul-template执行流程图" loading="lazy"></p>
<h3 id="初始化资源"><a href="#初始化资源" class="headerlink" title="初始化资源"></a>初始化资源</h3><p>consul-template启动后首先解析配置，并初始化相关资源</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//cli.go</span>
<span class="token comment">//dry：dry模式下会将渲染内容展示在stdout中，不会改变生成的文件，方便验证模板内容是否正确</span>
<span class="token comment">//once:是否只渲染一下，可用于调试</span>
runner<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">NewRunner</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> dry<span class="token punctuation">,</span> once<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ExitCodeRunnerError<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">go</span> runner<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//省略信号监控goroutine</span>
<span class="token string">``</span><span class="token string">`    
`</span><span class="token string">``</span><span class="token keyword">go</span>
<span class="token comment">//runner.go</span>
<span class="token comment">//NewRunner中调用init方法</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Runner<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//...省略配置解析，异常捕获等代码</span>
	<span class="token comment">//根据配置文件创建链接consul的客户端</span>
	clients<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newClientSet</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
	
	<span class="token comment">//创建监听器</span>
	watcher<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newWatcher</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>config<span class="token punctuation">,</span> clients<span class="token punctuation">,</span> r<span class="token punctuation">.</span>once<span class="token punctuation">)</span>

	<span class="token comment">//解析配置的模板</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ctmpl <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Templates <span class="token punctuation">&#123;</span>
		tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">NewTemplate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>template<span class="token punctuation">.</span>NewTemplateInput<span class="token punctuation">&#123;</span>
            <span class="token comment">//模板源文件的路径</span>
            Source<span class="token punctuation">:</span>        config<span class="token punctuation">.</span><span class="token function">StringVal</span><span class="token punctuation">(</span>ctmpl<span class="token punctuation">.</span>Source<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">//模板内容　和上面的路径必须保证有一个存在</span>
            Contents<span class="token punctuation">:</span>      config<span class="token punctuation">.</span><span class="token function">StringVal</span><span class="token punctuation">(</span>ctmpl<span class="token punctuation">.</span>Contents<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//省略部分初始化代码</span>

	<span class="token keyword">if</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Dedup<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>once <span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">//如果开启了de-dup属性的话，这里会创建de-dup管理器</span>
			r<span class="token punctuation">.</span>dedup<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">NewDedupManager</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Dedup<span class="token punctuation">,</span> clients<span class="token punctuation">,</span> r<span class="token punctuation">.</span>brain<span class="token punctuation">,</span> r<span class="token punctuation">.</span>templates<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>
</code></pre>
<h3 id="启动de-dup管理器和数据监控goroutine"><a href="#启动de-dup管理器和数据监控goroutine" class="headerlink" title="启动de-dup管理器和数据监控goroutine"></a>启动de-dup管理器和数据监控goroutine</h3><p>de-dup主要是为了优化性能，具体可参考上一篇基本用法。</p>
<pre class="language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Runner<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	
	<span class="token comment">//启动 de-duplication 管理器</span>
	<span class="token keyword">var</span> dedupCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>dedup <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>dedup<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			r<span class="token punctuation">.</span>ErrCh <span class="token operator">&lt;-</span> err
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		dedupCh <span class="token operator">=</span> r<span class="token punctuation">.</span>dedup<span class="token punctuation">.</span><span class="token function">UpdateCh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		r<span class="token punctuation">.</span>ErrCh <span class="token operator">&lt;-</span> err
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
	
	NEXT_Q<span class="token punctuation">:</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>templates <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>quiescenceMap<span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span> NEXT_Q
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span><span class="token function">templateConfigsFor</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token operator">*</span>c<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
					r<span class="token punctuation">.</span>quiescenceMap<span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newQuiescence</span><span class="token punctuation">(</span>
						r<span class="token punctuation">.</span>quiescenceCh<span class="token punctuation">,</span> <span class="token operator">*</span>c<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Min<span class="token punctuation">,</span> <span class="token operator">*</span>c<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Max<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
					<span class="token keyword">continue</span> NEXT_Q
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
				r<span class="token punctuation">.</span>quiescenceMap<span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newQuiescence</span><span class="token punctuation">(</span>
					r<span class="token punctuation">.</span>quiescenceCh<span class="token punctuation">,</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Min<span class="token punctuation">,</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Wait<span class="token punctuation">.</span>Max<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
				<span class="token keyword">continue</span> NEXT_Q
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>



	OUTER<span class="token punctuation">:</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> view <span class="token operator">:=</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">DataCh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			r<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">Dependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> view<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">//循环读取数据</span>
			<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> view <span class="token operator">:=</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">DataCh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
					r<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">Dependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> view<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
					<span class="token keyword">break</span> OUTER
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>dedupCh<span class="token punctuation">:</span>
			<span class="token comment">//接收到de-dup消息</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[INFO] (runner) watcher triggered by de-duplication manager"</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span> OUTER

		<span class="token punctuation">&#125;</span>
		<span class="token comment">//开始渲染数据</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			r<span class="token punctuation">.</span>ErrCh <span class="token operator">&lt;-</span> err
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h3><p>consul-template的模板语法其实是采用的golang模板的模板语法，通过自定义函数，来进行数据注入</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//runner.go</span>
<span class="token comment">//go runner.Start()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Runner<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	
	<span class="token keyword">var</span> newRenderEvent<span class="token punctuation">,</span> wouldRenderAny<span class="token punctuation">,</span> renderedAny <span class="token builtin">bool</span>
	runCtx <span class="token operator">:=</span> <span class="token operator">&amp;</span>templateRunCtx<span class="token punctuation">&#123;</span>
		depsMap<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>dep<span class="token punctuation">.</span>Dependency<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
    <span class="token comment">//渲染模板</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tmpl <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>templates <span class="token punctuation">&#123;</span>
		<span class="token comment">//渲染单个模板</span>
		event<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">runTemplate</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">,</span> runCtx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>

	<span class="token punctuation">&#125;</span>
    <span class="token comment">//渲染模板完毕执行命令</span>
	<span class="token keyword">var</span> errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> runCtx<span class="token punctuation">.</span>commands <span class="token punctuation">&#123;</span>
		command <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">StringVal</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Exec<span class="token punctuation">.</span>Command<span class="token punctuation">)</span>
		env <span class="token operator">:=</span> t<span class="token punctuation">.</span>Exec<span class="token punctuation">.</span>Env<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		env<span class="token punctuation">.</span>Custom <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">childEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> env<span class="token punctuation">.</span>Custom<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">spawnChild</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spawnChildInput<span class="token punctuation">&#123;</span>
			<span class="token comment">//省略</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"failed to execute command %q from %s"</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>
</code></pre>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//runner.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Runner<span class="token punctuation">)</span> <span class="token function">runTemplate</span><span class="token punctuation">(</span>tmpl <span class="token operator">*</span>template<span class="token punctuation">.</span>Template<span class="token punctuation">,</span> runCtx <span class="token operator">*</span>templateRunCtx<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RenderEvent<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	
	<span class="token comment">// 检查本示例节点是否是leader节点</span>
	isLeader <span class="token operator">:=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>dedup <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		isLeader <span class="token operator">=</span> r<span class="token punctuation">.</span>dedup<span class="token punctuation">.</span><span class="token function">IsLeader</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

    <span class="token comment">//尝试渲染模板</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>template<span class="token punctuation">.</span>ExecuteInput<span class="token punctuation">&#123;</span>
		Brain<span class="token punctuation">:</span> r<span class="token punctuation">.</span>brain<span class="token punctuation">,</span>
		Env<span class="token punctuation">:</span>   r<span class="token punctuation">.</span><span class="token function">childEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> tmpl<span class="token punctuation">.</span><span class="token function">Source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//检查模板渲染所需要的���据是否都满足了，如果不满足，则加入监控列表</span>
	missing<span class="token punctuation">,</span> used <span class="token operator">:=</span> result<span class="token punctuation">.</span>Missing<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Used
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> used<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> isLeader <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">Watching</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			missing<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> runCtx<span class="token punctuation">.</span>depsMap<span class="token punctuation">[</span>d<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
			runCtx<span class="token punctuation">.</span>depsMap<span class="token punctuation">[</span>d<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> d
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> l <span class="token operator">:=</span> unwatched<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> unwatched<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> isLeader <span class="token operator">||</span> <span class="token operator">!</span>d<span class="token punctuation">.</span><span class="token function">CanShare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">//注意此处将调用goroutine监控consul kv的变化</span>
				r<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> event<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

    <span class="token comment">//如果开启了de-duplication模式，并且本示例为leader节点，则更新consul中模板渲染的结果，便于其他节点使用</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>dedup <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> isLeader <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>dedup<span class="token punctuation">.</span><span class="token function">UpdateDeps</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">,</span> used<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[ERR] (runner) failed to update dependency data for de-duplication: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//如果开启了quiescence特性，则检查一定时间内是否已经更新过了，如果更新过了，不再更新，直接返回</span>
	<span class="token keyword">if</span> q<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>quiescenceMap<span class="token punctuation">[</span>tmpl<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		q<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		event<span class="token punctuation">.</span>ForQuiescence <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token keyword">return</span> event<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 对于每一个模板，将其渲染后的数据写入文件，并存储需要后续执行的命令</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> templateConfig <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span><span class="token function">templateConfigsFor</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	
		result<span class="token punctuation">,</span> err <span class="token operator">:=</span> renderer<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>renderer<span class="token punctuation">.</span>RenderInput<span class="token punctuation">&#123;</span>
			Backup<span class="token punctuation">:</span>         config<span class="token punctuation">.</span><span class="token function">BoolVal</span><span class="token punctuation">(</span>templateConfig<span class="token punctuation">.</span>Backup<span class="token punctuation">)</span><span class="token punctuation">,</span>
			Contents<span class="token punctuation">:</span>       result<span class="token punctuation">.</span>Output<span class="token punctuation">,</span>
			CreateDestDirs<span class="token punctuation">:</span> config<span class="token punctuation">.</span><span class="token function">BoolVal</span><span class="token punctuation">(</span>templateConfig<span class="token punctuation">.</span>CreateDestDirs<span class="token punctuation">)</span><span class="token punctuation">,</span>
			Dry<span class="token punctuation">:</span>            r<span class="token punctuation">.</span>dry<span class="token punctuation">,</span>
			DryStream<span class="token punctuation">:</span>      r<span class="token punctuation">.</span>outStream<span class="token punctuation">,</span>
			Path<span class="token punctuation">:</span>           config<span class="token punctuation">.</span><span class="token function">StringVal</span><span class="token punctuation">(</span>templateConfig<span class="token punctuation">.</span>Destination<span class="token punctuation">)</span><span class="token punctuation">,</span>
			Perms<span class="token punctuation">:</span>          config<span class="token punctuation">.</span><span class="token function">FileModeVal</span><span class="token punctuation">(</span>templateConfig<span class="token punctuation">.</span>Perms<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		
		<span class="token keyword">if</span> result<span class="token punctuation">.</span>DidRender <span class="token punctuation">&#123;</span>
			<span class="token comment">//省略模板渲染后执行后续命令的代码</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> event<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//renderer/renderer.go</span>
<span class="token keyword">func</span> <span class="token function">Render</span><span class="token punctuation">(</span>i <span class="token operator">*</span>RenderInput<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RenderResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	existing<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed reading file"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
    <span class="token comment">//读取上次渲染后的结果，比较和本次结果是否一致，一致的话就不再重复写入</span>
	<span class="token keyword">if</span> bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Contents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>RenderResult<span class="token punctuation">&#123;</span>
			DidRender<span class="token punctuation">:</span>   <span class="token boolean">false</span><span class="token punctuation">,</span>
			WouldRender<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			Contents<span class="token punctuation">:</span>    existing<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> i<span class="token punctuation">.</span>Dry <span class="token punctuation">&#123;</span>
        <span class="token comment">//开启dry模式的话，不写入文件，只打印结果</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>DryStream<span class="token punctuation">,</span> <span class="token string">"> %s\n%s"</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Contents<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//否则，确保原子写入文件</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AtomicWrite</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> i<span class="token punctuation">.</span>CreateDestDirs<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Contents<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Perms<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Backup<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed writing file"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>RenderResult<span class="token punctuation">&#123;</span>
		DidRender<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span>
		WouldRender<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		Contents<span class="token punctuation">:</span>    i<span class="token punctuation">.</span>Contents<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code></pre>


<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//template/template.go</span>
<span class="token keyword">type</span> ExecuteInput <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Brain 存储模板渲染所需要的数据</span>
	Brain <span class="token operator">*</span>Brain
	Env <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> Brain <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    sync<span class="token punctuation">.</span>RWMutex
    <span class="token comment">//判断是否收到数据更新</span>
	receivedData <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment">//存储具体的数据</span>
    data <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//解析渲染模板：一、需要模板　二需要数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Template<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>i <span class="token operator">*</span>ExecuteInput<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ExecuteResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		i <span class="token operator">=</span> <span class="token operator">&amp;</span>ExecuteInput<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> used<span class="token punctuation">,</span> missing dep<span class="token punctuation">.</span>Set
    <span class="token comment">//consul-template使用的go自带的模板渲染引擎</span>
    tmpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token comment">//自定义分隔符</span>
    tmpl<span class="token punctuation">.</span><span class="token function">Delims</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>leftDelim<span class="token punctuation">,</span> t<span class="token punctuation">.</span>rightDelim<span class="token punctuation">)</span>
    <span class="token comment">//自定义函数，包括需要渲染的数据都在自定义函数里面</span>
	tmpl<span class="token punctuation">.</span><span class="token function">Funcs</span><span class="token punctuation">(</span><span class="token function">funcMap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>funcMapInput<span class="token punctuation">&#123;</span>
		t<span class="token punctuation">:</span>       tmpl<span class="token punctuation">,</span>
		brain<span class="token punctuation">:</span>   i<span class="token punctuation">.</span>Brain<span class="token punctuation">,</span>
		env<span class="token punctuation">:</span>     i<span class="token punctuation">.</span>Env<span class="token punctuation">,</span>
		used<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>used<span class="token punctuation">,</span>
		missing<span class="token punctuation">:</span> <span class="token operator">&amp;</span>missing<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//解析模板</span>
	tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

	<span class="token comment">//开始渲染，返回结果放在b中，这里需要传的数据为nil，是因为数据都在自定义函数里面</span>
	<span class="token keyword">var</span> b bytes<span class="token punctuation">.</span>Buffer
	<span class="token keyword">if</span> err <span class="token operator">:=</span> tmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"execute"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ExecuteResult<span class="token punctuation">&#123;</span>
		Used<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>used<span class="token punctuation">,</span>
		Missing<span class="token punctuation">:</span> <span class="token operator">&amp;</span>missing<span class="token punctuation">,</span>
		Output<span class="token punctuation">:</span>  b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">funcMap</span><span class="token punctuation">(</span>i <span class="token operator">*</span>funcMapInput<span class="token punctuation">)</span> template<span class="token punctuation">.</span>FuncMap <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> template<span class="token punctuation">.</span>FuncMap<span class="token punctuation">&#123;</span>
		<span class="token string">"datacenters"</span><span class="token punctuation">:</span>  <span class="token function">datacentersFunc</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>brain<span class="token punctuation">,</span> i<span class="token punctuation">.</span>used<span class="token punctuation">,</span> i<span class="token punctuation">.</span>missing<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"file"</span><span class="token punctuation">:</span>         <span class="token function">fileFunc</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>brain<span class="token punctuation">,</span> i<span class="token punctuation">.</span>used<span class="token punctuation">,</span> i<span class="token punctuation">.</span>missing<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//所有的值都放在这里面，因此在模板中定义时需要添加上 &#123;&#123; key xxx&#125;&#125;</span>
        <span class="token comment">//keyFunc这个函数主要就是从brain中取出数据</span>
        <span class="token string">"key"</span><span class="token punctuation">:</span>          <span class="token function">keyFunc</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>brain<span class="token punctuation">,</span> i<span class="token punctuation">.</span>used<span class="token punctuation">,</span> i<span class="token punctuation">.</span>missing<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//省略其它自定义函数</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</code></pre>

<h3 id="监控consul-kv"><a href="#监控consul-kv" class="headerlink" title="监控consul-kv"></a>监控consul-kv</h3><p>这里监控consul的数据，采用的consul的阻塞get方法，默认会等待1分钟。如果有数据更新，立即返回；否则会超时返回。</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//watch/watcher.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>Watcher<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>d dep<span class="token punctuation">.</span>Dependency<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//创建监听视图</span>
	v<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NewViewInput<span class="token punctuation">&#123;</span>
		Dependency<span class="token punctuation">:</span> d<span class="token punctuation">,</span>
		Clients<span class="token punctuation">:</span>    w<span class="token punctuation">.</span>clients<span class="token punctuation">,</span>
		MaxStale<span class="token punctuation">:</span>   w<span class="token punctuation">.</span>maxStale<span class="token punctuation">,</span>
		Once<span class="token punctuation">:</span>       w<span class="token punctuation">.</span>once<span class="token punctuation">,</span>
		RetryFunc<span class="token punctuation">:</span>  retryFunc<span class="token punctuation">,</span>
		VaultGrace<span class="token punctuation">:</span> w<span class="token punctuation">.</span>vaultGrace<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"watcher"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	w<span class="token punctuation">.</span>depViewMap<span class="token punctuation">[</span>d<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token comment">//开启单独的poll</span>
	<span class="token keyword">go</span> v<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>dataCh<span class="token punctuation">,</span> w<span class="token punctuation">.</span>errCh<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">// watch/view.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>View<span class="token punctuation">)</span> <span class="token function">poll</span><span class="token punctuation">(</span>viewCh <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>View<span class="token punctuation">,</span> errCh <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> retries <span class="token builtin">int</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		doneCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		successCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		fetchErrCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">//开启单独的goroutine从consul中获取数据</span>
		<span class="token keyword">go</span> v<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>doneCh<span class="token punctuation">,</span> successCh<span class="token punctuation">,</span> fetchErrCh<span class="token punctuation">)</span>

	WAIT<span class="token punctuation">:</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">//省略接收到数据后的一些充值操作</span>
		｝
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>


<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//watch/view.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>View<span class="token punctuation">)</span> <span class="token function">fetch</span><span class="token punctuation">(</span>doneCh<span class="token punctuation">,</span> successCh <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> errCh <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
	
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>v<span class="token punctuation">.</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>

		data<span class="token punctuation">,</span> rm<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>dependency<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dep<span class="token punctuation">.</span>QueryOptions<span class="token punctuation">&#123;</span>
			AllowStale<span class="token punctuation">:</span> allowStale<span class="token punctuation">,</span> <span class="token comment">//此变量决定是否从consul的flower节点拉取数据</span>
			WaitTime<span class="token punctuation">:</span>   defaultWaitTime<span class="token punctuation">,</span><span class="token comment">//defaultWaitTime = 60 * time.Second 默认超时时间为1分钟，不可以修改</span>
			WaitIndex<span class="token punctuation">:</span>  v<span class="token punctuation">.</span>lastIndex<span class="token punctuation">,</span><span class="token comment">//consul通过此字段来判断客户端和consul的数据是否同步</span>
			VaultGrace<span class="token punctuation">:</span> v<span class="token punctuation">.</span>vaultGrace<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">//通知收到了数据</span>
		<span class="token keyword">case</span> successCh <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">//省略内容</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-go" data-language="go"><code class="language-go"><span class="token comment">//dependency/kv_get.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>KVGetQuery<span class="token punctuation">)</span> <span class="token function">Fetch</span><span class="token punctuation">(</span>clients <span class="token operator">*</span>ClientSet<span class="token punctuation">,</span> opts <span class="token operator">*</span>QueryOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token operator">*</span>ResponseMetadata<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//这里会阻塞一分钟，在这一分钟内，如果数据有更新，会立即返回，否则会超时返回</span>
	pair<span class="token punctuation">,</span> qm<span class="token punctuation">,</span> err <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">Consul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">KV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>key<span class="token punctuation">,</span> opts<span class="token punctuation">.</span><span class="token function">ToConsulOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	rm <span class="token operator">:=</span> <span class="token operator">&amp;</span>ResponseMetadata<span class="token punctuation">&#123;</span>
		LastIndex<span class="token punctuation">:</span>   qm<span class="token punctuation">.</span>LastIndex<span class="token punctuation">,</span>
		LastContact<span class="token punctuation">:</span> qm<span class="token punctuation">.</span>LastContact<span class="token punctuation">,</span>
		Block<span class="token punctuation">:</span>       d<span class="token punctuation">.</span>block<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	value <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">return</span> value<span class="token punctuation">,</span> rm<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code></pre>



</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>哈利土土</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Consul template源码解析">https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul><script>document.addEventListener('copy', function (event) {
  const clipboardData = event.clipboardData || window.clipboardData;
  if (!clipboardData) { return; }
  const text = window.getSelection().toString();
  if (text) {
    event.preventDefault();
    clipboardData.setData('text/plain', text + '\n\n本文作者：哈利土土\n本文链接：https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/\n版权声明：本博客所有文章除特别声明外，均默认采用 CC BY-NC-SA 4.0 许可协议。');
  }
});</script></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2019/05/11/Consul-template%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/" rel="prev" title="Consul-template基本用法"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Consul-template基本用法</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2019/03/15/kong0-12-x%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%BA%94/" rel="next" title="kong0.12.x源码分析(五)---路由匹配策略"><span class="post-nav-text">kong0.12.x源码分析(五)---路由匹配策略</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div id="disqus_thread"></div><script>const disqusConfig = function() {
  this.page.url = "https://photon.fun/2019/05/09/Consul-template%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = "2019/05/09/Consul-template源码解析/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  this.page.title = "Consul template源码解析";
};
function loadDisqus() {
  // here we will only load the disqus <script> if not already loaded
  if (!window.DISQUS) {
    (function() {
      // DON'T EDIT BELOW THIS LINE
      const d = document,
        s = d.createElement("script");
      s.src = "https://xiaodongliu-com.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
  // if disqus <script> is already loaded, we just reset disqus the right way
  // see https://help.disqus.com/developer/using-disqus-on-ajax-sites
  else {
    DISQUS.reset({
      reload: true,
      config: function() {
        this.page.identifier = disqusConfig.page.identifier;
        this.page.url = disqusConfig.page.url;
      },
    });
  }
}</script><script src="/js/comments/disqus.js" type="module"></script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">浙ICP备20005773号</a></div><div class="copyright"><span>&copy; 2017 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 哈利土土</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.6</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>